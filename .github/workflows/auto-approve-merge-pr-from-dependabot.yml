name: Auto Merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: "0 * * * *"  # every hour (handles existing PRs)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-automerge:
    runs-on: ubuntu-latest

    steps:
      - name: Auto-merge Dependabot PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            async function processPR(pr) {
              if (pr.user.login !== "dependabot[bot]") return;

              if (pr.state !== "open") return;

              console.log(`Processing PR #${pr.number}`);

              try {
                await github.graphql(`
                  mutation {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: "${pr.node_id}",
                      mergeMethod: SQUASH
                    }) {
                      clientMutationId
                    }
                  }
                `);
                console.log(`Enabled auto-merge for #${pr.number}`);
              } catch (e) {
                console.log(`Auto-merge may already be enabled for #${pr.number}`);
              }
            }

            if (context.payload.pull_request) {
              await processPR(context.payload.pull_request);
            } else {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                base: "main"
              });

              for (const pr of prs) {
                await processPR(pr);
              }
            }
